name: Ktalk-Backend-CI/CD

on:
  push:
    branches: [ "develop" ]

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_HOST_NAME : ubuntu
  SERVER_SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_PRIVATE_KEY }}

  DOCKER_IMAGE_NAME: opensource-be
  DOCKER_IMAGE_VERSION: latest
  DOCKER_NAME: ${{ secrets.DOCKER_NAME }}
  DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
  DOCKER_CONTAINER_NAME: backend

  APPLICATION_PROD: ${{ secrets.APPLICATION_PROD }}
  FIREBASE_KEY: ${{ secrets.FIREBASE_KEY }}

  FULL_GITHUB_SHA: ${{ github.sha }}
  SHORT_GITHUB_SHA: 0

jobs:
  build-and-push-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set SHORT_GITHUB_SHA
        run: echo "SHORT_GITHUB_SHA=${FULL_GITHUB_SHA::7}" >> $GITHUB_ENV

      # docker-compose.yml 파일 생성 (환경변수 치환)
      - name: Generate docker-compose.yml from template
        run: envsubst < docker-compose.yml.template > docker-compose.yml
        env:
          DOCKER_NAME: ${{ env.DOCKER_NAME }}
          DOCKER_IMAGE_NAME: ${{ env.DOCKER_IMAGE_NAME }}
          DOCKER_IMAGE_VERSION: ${{ env.DOCKER_IMAGE_VERSION }}
          DOCKER_CONTAINER_NAME: ${{ env.DOCKER_CONTAINER_NAME }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up application-prod.properties
        run: |
          mkdir -p ./src/main/resources/
          echo '${{ env.APPLICATION_PROD }}' > ./src/main/resources/application.properties

      - name: Set up Firebase key
        run: |
          mkdir -p ./src/main/resources/firebase/
          echo '${{ env.FIREBASE_KEY }}' > ./src/main/resources/firebase/service-account.json

      - name: Grant execute permission for gradlew
        run: sudo chmod +x ./gradlew

      - name: Build with Gradle (Run tests)
        run: ./gradlew build

      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_VERSION }}

      - name: Login to Docker Hub using Access Token
        run: echo "$DOCKER_HUB_TOKEN" | docker login -u "$DOCKER_NAME" --password-stdin

      - name: Push the Docker image
        run: |
          docker image tag ${{ env.DOCKER_IMAGE_NAME }} ${{ env.DOCKER_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_VERSION }}
          docker image tag ${{ env.DOCKER_IMAGE_NAME }} ${{ env.DOCKER_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.SHORT_GITHUB_SHA }}
          docker push ${{ env.DOCKER_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_VERSION }}
          docker push ${{ env.DOCKER_NAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.SHORT_GITHUB_SHA }}

      # 생성된 docker-compose.yml을 EC2로 전송
      - name: Copy docker-compose.yml to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_HOST_NAME }}
          key: ${{ env.SERVER_SSH_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/home/${{ env.SERVER_HOST_NAME }}/"

      # docker compose (V2) 명령어로 배포
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_HOST_NAME }}
          key: ${{ env.SERVER_SSH_PRIVATE_KEY }}
          script: |
            # 1. Docker Hub 로그인
            echo "${{ env.DOCKER_HUB_TOKEN }}" | sudo docker login -u ${{ env.DOCKER_NAME }} --password-stdin
            
            # 2. 최신 이미지 Pull (docker-compose.yml은 이미 scp로 전송됨)
            sudo docker compose pull
            
            # 3. 컨테이너 실행 (변경된 컨테이너만 재시작)
            sudo docker compose up -d
            
            # 4. 불필요한 이미지 정리
            sudo docker image prune -f